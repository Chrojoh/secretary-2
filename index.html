<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C-WAGS Trial Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
        }

        .nav {
            background: #34495e;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
        }

        .nav button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }

        .nav button:hover {
            background: #2980b9;
        }

        .nav button.active {
            background: #e74c3c;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="password"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        input[type="checkbox"] {
            margin-right: 10px;
        }

        button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #229954;
        }

        .trial-card {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .trial-card h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .round-config {
            background: #f0f0f0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .day-config {
            background: #e8f4f8;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 2px solid #3498db;
        }

        .class-config {
            background: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background: #34495e;
            color: white;
        }

        tr:nth-child(even) {
            background: #f8f9fa;
        }

        .running-order-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ddd;
        }

        .running-order-item:hover {
            background: #e9ecef;
        }

        .running-order-item.dragging {
            opacity: 0.5;
        }

        .arrow-buttons button {
            padding: 5px 10px;
            margin-left: 5px;
            font-size: 14px;
        }

        .entry-link {
            background: #3498db;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }

        .entry-link a {
            color: white;
            word-break: break-all;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media print {
            .nav, .no-print {
                display: none !important;
            }
            
            body {
                background: white;
            }
        }

        .score-sheet-container {
            margin-bottom: 30px;
        }

        .score-input {
            width: 80px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>C-WAGS Trial Management System</h1>
    </div>

    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="section active">
            <h2>Login</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit">Login</button>
            </form>
        </div>

        <!-- Navigation -->
        <div id="navigation" class="nav">
            <button onclick="showSection('dashboard')" id="navDashboard">Dashboard</button>
            <button onclick="showSection('createTrial')" id="navCreateTrial">Create Trial</button>
            <button onclick="showSection('entryForm')" id="navEntryForm">Entry Form</button>
            <button onclick="showSection('runningOrder')" id="navRunningOrder">Running Order</button>
            <button onclick="showSection('results')" id="navResults">Results</button>
            <button onclick="showSection('summary')" id="navSummary">Summary</button>
            <button onclick="logout()">Logout</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboardSection" class="section">
            <h2>Dashboard</h2>
            <div id="trialsList"></div>
        </div>

        <!-- Create Trial -->
        <div id="createTrialSection" class="section">
            <h2>Create New Trial</h2>
            <form id="createTrialForm" onsubmit="handleCreateTrial(event)">
                <div class="form-group">
                    <label>Trial Type:</label>
                    <label>
                        <input type="radio" name="trialType" value="standalone" checked onchange="updateTrialType()">
                        Standalone Trial
                    </label>
                    <label>
                        <input type="radio" name="trialType" value="league" onchange="updateTrialType()">
                        League Trial
                    </label>
                </div>

                <!-- Standalone Configuration -->
                <div id="standaloneConfig">
                    <div class="form-group">
                        <label for="trialDate">Trial Date:</label>
                        <input type="date" id="trialDate" required>
                    </div>
                    <div class="form-group">
                        <label for="className">Class:</label>
                        <select id="className" required>
                            <option value="">Select a class</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="numRounds">Number of Rounds:</label>
                        <input type="number" id="numRounds" min="1" max="5" value="1" onchange="updateRoundsConfig()">
                    </div>
                    <div id="roundsConfig"></div>
                </div>

                <!-- League Configuration -->
                <div id="leagueConfig" style="display: none;">
                    <div class="form-group">
                        <label for="numDays">Number of Days:</label>
                        <input type="number" id="numDays" min="1" max="10" value="1" onchange="updateDaysConfig()">
                    </div>
                    <div id="daysConfig"></div>
                </div>

                <button type="submit">Create Trial</button>
            </form>
        </div>

        <!-- Entry Form -->
        <div id="entryFormSection" class="section">
            <h2>Entry Form</h2>
            <div id="entryFormContent"></div>
        </div>

        <!-- Running Order -->
        <div id="runningOrderSection" class="section">
            <h2>Running Order</h2>
            <div id="runningOrderContent"></div>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="section">
            <h2>Results</h2>
            <div id="resultsContent"></div>
        </div>

        <!-- Summary -->
        <div id="summarySection" class="section">
            <h2>Summary</h2>
            <div id="summaryContent"></div>
        </div>
    </div>

    <script>
        // Data structures
        const appData = {
            currentUser: null,
            currentTrial: null,
            trials: [],
            entries: [],
            classes: [
                'Patrol 1', 'Patrol 2', 'Patrol 3',
                'Ranger 1', 'Ranger 2', 'Ranger 3',
                'Investigator 1', 'Investigator 2', 'Investigator 3',
                'Detective Diversions R1', 'Detective Diversions R2',
                'Super Sleuth 1', 'Super Sleuth 2', 'Super Sleuth 3', 'Super Sleuth 4',
                'Dasher 1', 'Dasher 2', 'Dasher 3', 'Dasher 4', 'Dasher 5'
            ],
            judges: [
                'Sarah Knight', 'Lane Michie', 'Gary Truitt',
                'William Johnson', 'Patty Brown', 'Sandy Williams'
            ]
        };

        // Initialize application
        function init() {
            loadFromStorage();
            populateClassDropdown();
            
            // Check for entry link
            const urlParams = new URLSearchParams(window.location.search);
            const entryId = urlParams.get('entry');
            if (entryId) {
                showEntryFormDirect(entryId);
            }
        }

        // Storage functions
        function saveToStorage() {
            localStorage.setItem('cwags_trials', JSON.stringify(appData.trials));
            localStorage.setItem('cwags_entries', JSON.stringify(appData.entries));
        }

        function loadFromStorage() {
            const trials = localStorage.getItem('cwags_trials');
            const entries = localStorage.getItem('cwags_entries');
            
            if (trials) appData.trials = JSON.parse(trials);
            if (entries) appData.entries = JSON.parse(entries);
        }

        // Login handling
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            console.log('Login attempt:', { username: username, passwordLength: password.length });
            
            // Simple authentication - accept 'password' or blank for testing
            if (password === 'password' || password === '') {
                appData.currentUser = username || 'Guest';
                document.getElementById('loginSection').classList.remove('active');
                document.getElementById('navigation').style.display = 'block';
                showSection('dashboard');
                loadDashboard();
            } else {
                alert('Invalid password. Please use "password" or leave blank.');
            }
        }

        function logout() {
            appData.currentUser = null;
            appData.currentTrial = null;
            document.getElementById('navigation').style.display = 'none';
            showSection('login');
        }

        // Navigation
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Show selected section
            document.getElementById(section + 'Section').classList.add('active');
            
            // Update nav buttons
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            const navButton = document.getElementById('nav' + section.charAt(0).toUpperCase() + section.slice(1));
            if (navButton) navButton.classList.add('active');
            
            // Load section data
            if (section === 'dashboard') loadDashboard();
            else if (section === 'runningOrder') loadRunningOrder();
            else if (section === 'results') loadResults();
            else if (section === 'summary') loadSummary();
        }

        // Dashboard
        function loadDashboard() {
            const container = document.getElementById('trialsList');
            const userTrials = appData.currentUser === 'TheAdmin' ? 
                appData.trials : 
                appData.trials.filter(t => t.creator === appData.currentUser);
            
            if (userTrials.length === 0) {
                container.innerHTML = '<p>No trials created yet. <button onclick="showSection(\'createTrial\')">Create your first trial</button></p>';
                return;
            }
            
            let html = '';
            userTrials.forEach((trial, index) => {
                html += `
                    <div class="trial-card">
                        <h3>${trial.name}</h3>
                        <p>Type: ${trial.type}</p>
                        <p>Dates: ${trial.dates.join(', ')}</p>
                        <p>Classes: ${trial.classes.length}</p>
                        <button onclick="selectTrial(${index})">Select</button>
                        <button onclick="viewEntryForm(${index})">Entry Form</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function selectTrial(index) {
            appData.currentTrial = appData.trials[index];
            alert('Trial selected: ' + appData.currentTrial.name);
        }

        function viewEntryForm(index) {
            appData.currentTrial = appData.trials[index];
            showSection('entryForm');
            generateEntryForm();
        }

        // Trial creation
        function populateClassDropdown() {
            const select = document.getElementById('className');
            select.innerHTML = '<option value="">Select a class</option>';
            appData.classes.forEach(cls => {
                select.innerHTML += `<option value="${cls}">${cls}</option>`;
            });
        }

        function updateTrialType() {
            const type = document.querySelector('input[name="trialType"]:checked').value;
            document.getElementById('standaloneConfig').style.display = type === 'standalone' ? 'block' : 'none';
            document.getElementById('leagueConfig').style.display = type === 'league' ? 'block' : 'none';
        }

        function updateRoundsConfig() {
            const numRounds = parseInt(document.getElementById('numRounds').value);
            const container = document.getElementById('roundsConfig');
            
            let html = '';
            for (let i = 1; i <= numRounds; i++) {
                html += `
                    <div class="round-config">
                        <h4>Round ${i}</h4>
                        <div class="form-group">
                            <label for="judge_r${i}">Judge:</label>
                            <select id="judge_r${i}" required>
                                <option value="">Select a judge</option>
                                ${appData.judges.map(j => `<option value="${j}">${j}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="feo_r${i}">
                                FEO offered for this round?
                            </label>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function updateDaysConfig() {
            const numDays = parseInt(document.getElementById('numDays').value);
            const container = document.getElementById('daysConfig');
            
            let html = '';
            for (let day = 1; day <= numDays; day++) {
                html += `
                    <div class="day-config">
                        <h3>Day ${day}</h3>
                        <div class="form-group">
                            <label for="date_d${day}">Date:</label>
                            <input type="date" id="date_d${day}" required>
                        </div>
                        <div class="form-group">
                            <label for="numClasses_d${day}">Number of Classes:</label>
                            <input type="number" id="numClasses_d${day}" min="1" max="10" value="1" onchange="updateClassesForDay(${day})">
                        </div>
                        <div id="classes_d${day}"></div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Initialize first class for each day
            for (let day = 1; day <= numDays; day++) {
                updateClassesForDay(day);
            }
        }

        function updateClassesForDay(day) {
            const numClasses = parseInt(document.getElementById(`numClasses_d${day}`).value);
            const container = document.getElementById(`classes_d${day}`);
            
            let html = '';
            for (let cls = 1; cls <= numClasses; cls++) {
                html += `
                    <div class="class-config">
                        <h4>Class ${cls}</h4>
                        <div class="form-group">
                            <label for="class_d${day}_c${cls}">Class Name:</label>
                            <select id="class_d${day}_c${cls}" required>
                                <option value="">Select a class</option>
                                ${appData.classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rounds_d${day}_c${cls}">Number of Rounds:</label>
                            <input type="number" id="rounds_d${day}_c${cls}" min="1" max="5" value="1" onchange="updateRoundsForClass(${day}, ${cls})">
                        </div>
                        <div id="rounds_d${day}_c${cls}_config"></div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Initialize rounds
            for (let cls = 1; cls <= numClasses; cls++) {
                updateRoundsForClass(day, cls);
            }
        }

        function updateRoundsForClass(day, cls) {
            const numRounds = parseInt(document.getElementById(`rounds_d${day}_c${cls}`).value);
            const container = document.getElementById(`rounds_d${day}_c${cls}_config`);
            
            let html = '';
            for (let round = 1; round <= numRounds; round++) {
                html += `
                    <div style="margin-left: 20px; margin-bottom: 10px;">
                        <strong>Round ${round}</strong>
                        <div class="form-group">
                            <label for="judge_d${day}_c${cls}_r${round}">Judge:</label>
                            <select id="judge_d${day}_c${cls}_r${round}" required>
                                <option value="">Select a judge</option>
                                ${appData.judges.map(j => `<option value="${j}">${j}</option>`).join('')}
                            </select>
                        </div>
                        <label>
                            <input type="checkbox" id="feo_d${day}_c${cls}_r${round}">
                            FEO offered?
                        </label>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function handleCreateTrial(event) {
            event.preventDefault();
            
            const trialType = document.querySelector('input[name="trialType"]:checked').value;
            const trial = {
                id: Date.now(),
                creator: appData.currentUser,
                type: trialType,
                name: '',
                dates: [],
                classes: []
            };
            
            if (trialType === 'standalone') {
                const date = document.getElementById('trialDate').value;
                const className = document.getElementById('className').value;
                const numRounds = parseInt(document.getElementById('numRounds').value);
                
                trial.name = `${className} - ${date}`;
                trial.dates = [date];
                
                const rounds = [];
                for (let i = 1; i <= numRounds; i++) {
                    rounds.push({
                        round: i,
                        judge: document.getElementById(`judge_r${i}`).value,
                        feo: document.getElementById(`feo_r${i}`).checked
                    });
                }
                
                trial.classes.push({
                    date: date,
                    className: className,
                    rounds: rounds
                });
            } else {
                // League trial
                const numDays = parseInt(document.getElementById('numDays').value);
                trial.name = 'League Trial - ' + new Date().toLocaleDateString();
                
                for (let day = 1; day <= numDays; day++) {
                    const date = document.getElementById(`date_d${day}`).value;
                    trial.dates.push(date);
                    
                    const numClasses = parseInt(document.getElementById(`numClasses_d${day}`).value);
                    
                    for (let cls = 1; cls <= numClasses; cls++) {
                        const className = document.getElementById(`class_d${day}_c${cls}`).value;
                        const numRounds = parseInt(document.getElementById(`rounds_d${day}_c${cls}`).value);
                        
                        const rounds = [];
                        for (let round = 1; round <= numRounds; round++) {
                            rounds.push({
                                round: round,
                                judge: document.getElementById(`judge_d${day}_c${cls}_r${round}`).value,
                                feo: document.getElementById(`feo_d${day}_c${cls}_r${round}`).checked
                            });
                        }
                        
                        trial.classes.push({
                            date: date,
                            className: className,
                            rounds: rounds
                        });
                    }
                }
            }
            
            appData.trials.push(trial);
            appData.currentTrial = trial;
            saveToStorage();
            
            alert('Trial created successfully!');
            showSection('entryForm');
            generateEntryForm();
        }

        // Entry form
        function generateEntryForm() {
            if (!appData.currentTrial) return;
            
            const container = document.getElementById('entryFormContent');
            const entryLink = `${window.location.origin}${window.location.pathname}?entry=${appData.currentTrial.id}`;
            
            let html = `
                <div class="entry-link">
                    <p><strong>Entry Form Link:</strong></p>
                    <p><a href="${entryLink}" target="_blank">${entryLink}</a></p>
                    <button onclick="navigator.clipboard.writeText('${entryLink}')">Copy Link</button>
                </div>
                
                <h3>Entry Form Preview</h3>
                <form id="trialEntryForm" onsubmit="handleEntrySubmit(event)">
                    <div class="form-group">
                        <label for="handlerName">Handler Name:</label>
                        <input type="text" id="handlerName" required>
                    </div>
                    <div class="form-group">
                        <label for="dogCallName">Dog's Call Name:</label>
                        <input type="text" id="dogCallName" required>
                    </div>
                    <div class="form-group">
                        <label for="dogRegNumber">Registration Number:</label>
                        <input type="text" id="dogRegNumber" required>
                    </div>
                    
                    <h4>Select Classes to Enter:</h4>
            `;
            
            appData.currentTrial.classes.forEach((cls, index) => {
                const judges = cls.rounds.map(r => r.judge).join(', ');
                html += `
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="classes" value="${index}">
                            ${cls.date} - ${cls.className} (Judge: ${judges})
                        </label>
                    </div>
                `;
            });
            
            html += '<button type="submit">Submit Entry</button></form>';
            container.innerHTML = html;
        }

        function handleEntrySubmit(event) {
            event.preventDefault();
            
            const selectedClasses = Array.from(document.querySelectorAll('input[name="classes"]:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selectedClasses.length === 0) {
                alert('Please select at least one class');
                return;
            }
            
            const entry = {
                id: Date.now(),
                trialId: appData.currentTrial.id,
                handlerName: document.getElementById('handlerName').value,
                dogCallName: document.getElementById('dogCallName').value,
                dogRegNumber: document.getElementById('dogRegNumber').value,
                classes: selectedClasses,
                timestamp: new Date().toISOString()
            };
            
            appData.entries.push(entry);
            saveToStorage();
            
            alert('Entry submitted successfully!');
            document.getElementById('trialEntryForm').reset();
        }

        function showEntryFormDirect(trialId) {
            const trial = appData.trials.find(t => t.id == trialId);
            if (trial) {
                appData.currentTrial = trial;
                document.getElementById('loginSection').classList.remove('active');
                showSection('entryForm');
                generateEntryForm();
            }
        }

        // Running order
        function loadRunningOrder() {
            if (!appData.currentTrial) {
                document.getElementById('runningOrderContent').innerHTML = '<p>Please select a trial first.</p>';
                return;
            }
            
            const container = document.getElementById('runningOrderContent');
            const trialEntries = appData.entries.filter(e => e.trialId === appData.currentTrial.id);
            
            if (trialEntries.length === 0) {
                container.innerHTML = '<p>No entries yet for this trial.</p>';
                return;
            }
            
            // Group entries by date, judge, class, round
            const groups = {};
            
            trialEntries.forEach(entry => {
                entry.classes.forEach(classIndex => {
                    const cls = appData.currentTrial.classes[classIndex];
                    cls.rounds.forEach(round => {
                        const key = `${cls.date}_${round.judge}_${cls.className}_Round${round.round}`;
                        if (!groups[key]) {
                            groups[key] = {
                                date: cls.date,
                                judge: round.judge,
                                className: cls.className,
                                round: round.round,
                                entries: []
                            };
                        }
                        groups[key].entries.push(entry);
                    });
                });
            });
            
            let html = '<h3>Running Order</h3>';
            
            Object.keys(groups).sort().forEach(key => {
                const group = groups[key];
                html += `
                    <div class="round-config">
                        <h4>${group.date} - ${group.judge} - ${group.className} - Round ${group.round}</h4>
                        <div id="order_${key}" data-key="${key}">
                `;
                
                group.entries.forEach((entry, index) => {
                    html += `
                        <div class="running-order-item" draggable="true" data-index="${index}">
                            <span>${index + 1}. ${entry.handlerName} - ${entry.dogCallName}</span>
                            <div class="arrow-buttons">
                                <button onclick="moveEntry('${key}', ${index}, -1)">↑</button>
                                <button onclick="moveEntry('${key}', ${index}, 1)">↓</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <button onclick="submitRunningOrder('${key}')">Submit Running Order</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            initDragAndDrop();
        }

        function moveEntry(key, index, direction) {
            const container = document.getElementById(`order_${key}`);
            const items = Array.from(container.querySelectorAll('.running-order-item'));
            
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < items.length) {
                const item = items[index];
                const targetItem = items[newIndex];
                
                if (direction === -1) {
                    container.insertBefore(item, targetItem);
                } else {
                    container.insertBefore(targetItem, item);
                }
                
                updateOrderIndices(key);
            }
        }

        function updateOrderIndices(key) {
            const container = document.getElementById(`order_${key}`);
            const items = container.querySelectorAll('.running-order-item');
            
            items.forEach((item, index) => {
                item.dataset.index = index;
                const span = item.querySelector('span');
                span.textContent = span.textContent.replace(/^\d+\./, `${index + 1}.`);
            });
