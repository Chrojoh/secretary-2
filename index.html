<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .header h1 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        /* Login/Register Modal Styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .auth-modal {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
        }
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .auth-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .auth-tab:first-child {
            border-radius: 8px 0 0 8px;
        }
        .auth-tab:last-child {
            border-radius: 0 8px 8px 0;
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }
        .auth-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .auth-input:focus {
            border-color: #667eea;
            outline: none;
        }
        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        /* User Info Bar */
        .user-bar {
            text-align: right;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            color: #2c5aa0;
            font-weight: bold;
        }
        .logout-btn {
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .logout-btn:hover {
            background: #c82333;
        }
        
        /* My Trials Section */
        .my-trials {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .trial-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .trial-info {
            flex: 1;
        }
        .trial-name {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 5px;
        }
        .trial-meta {
            font-size: 14px;
            color: #666;
        }
        .trial-actions {
            display: flex;
            gap: 10px;
        }
        .edit-btn, .delete-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        .edit-btn {
            background: #28a745;
            color: white;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        .edit-btn:hover {
            background: #218838;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
        }
        .nav-tab {
            padding: 15px 25px;
            background: #f0f0f0;
            border: 2px solid #d0d0d0;
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: #666;
        }
        .nav-tab:hover {
            background: #e8e8e8;
            border-color: #bbb;
            color: #333;
        }
        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            border-color: transparent;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .initial-question {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .day-container {
            border: 2px solid #2c5aa0;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .day-header {
            background: #2c5aa0;
            color: white;
            padding: 10px 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            font-size: 18px;
        }
        .classes-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        .form-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        input[type="number"] { width: 100px; }
        input[type="text"] { width: 250px; }
        input[type="date"] { width: 180px; }
        select { width: 250px; }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-modal">
            <h2>Welcome to Trial Management System</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login', this)">Login</button>
                <button class="auth-tab" onclick="showAuthTab('register', this)">Register</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <input type="text" id="loginUsername" class="auth-input" placeholder="Username" required>
                <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-button">Login</button>
                <div id="loginMessage" style="margin-top: 15px;"></div>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <input type="text" id="regUsername" class="auth-input" placeholder="Choose Username (3+ characters)" required minlength="3">
                <input type="password" id="regPassword" class="auth-input" placeholder="Choose Password (6+ characters)" required minlength="6">
                <input type="password" id="regConfirmPassword" class="auth-input" placeholder="Confirm Password" required>
                <input type="text" id="regFullName" class="auth-input" placeholder="Full Name" required>
                <input type="email" id="regEmail" class="auth-input" placeholder="Email Address" required>
                <button type="submit" class="auth-button">Register</button>
                <div id="registerMessage" style="margin-top: 15px;"></div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- User Bar -->
        <div class="user-bar">
            <div class="user-info" id="userInfo"></div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="container">
            <div class="header">
                <h1>Trial Management System</h1>
                <p>Track judges across multiple days, classes, and rounds</p>
            </div>

            <!-- My Trials Section -->
            <div class="my-trials">
                <h3>My Trials</h3>
                <div id="myTrialsList"></div>
                <button onclick="createNewTrial()">Create New Trial</button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('setup', this)">Trial Setup</button>
                <button class="nav-tab" onclick="showTab('entry', this)">Entry Form</button>
                <button class="nav-tab" onclick="showTab('results', this)">Results</button>
            </div>

            <!-- Setup Tab -->
            <div id="setup" class="tab-content active">
                <div class="initial-question">
                    <h3 id="trialTitle">New Trial Setup</h3>
                    <div class="form-group">
                        <span class="label">Trial Name:</span>
                        <input type="text" id="trialName" placeholder="Enter trial name" style="width: 300px;">
                    </div>
                    <div class="form-group">
                        <span class="label">How many days in trial?</span>
                        <input type="number" id="trialDays" min="1" max="30" placeholder="Enter number">
                        <button type="button" onclick="generateDays()">Generate Days</button>
                    </div>
                </div>

                <div id="daysContainer"></div>
                
                <!-- Save Trial Section -->
                <div id="saveTrialSection" style="display: none; margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #e8f4f8, #f0f8ff); border-radius: 12px; text-align: center; border: 2px solid #2c5aa0;">
                    <h3 style="color: #2c5aa0; margin-bottom: 15px;">ðŸŽ¯ Ready to Save Your Trial?</h3>
                    <p style="margin-bottom: 20px; color: #666;">All days have been configured. Review your trial setup and save to generate the entry form link.</p>
                    
                    <div class="form-group" style="justify-content: center; margin-bottom: 20px;">
                        <button type="button" onclick="saveTrialData()" style="font-size: 16px; padding: 15px 30px; background: linear-gradient(45deg, #28a745, #20c997);">ðŸ’¾ Save Trial & Generate Entry Link</button>
                    </div>
                    
                    <p style="font-size: 14px; color: #666; margin: 0;">Once saved, you'll receive a shareable link for participant registration.</p>
                </div>

                <!-- Entry Form Link Section -->
                <div id="entryFormLink" style="display: none; margin-top: 20px; padding: 20px; background: #e8f4f8; border-radius: 8px; text-align: center;">
                    <h3 style="color: #2c5aa0;">ðŸŽ‰ Trial Setup Complete!</h3>
                    <p><strong>Share this URL for participants to register:</strong></p>
                    <div style="margin: 15px 0;">
                        <input type="text" id="shareableURL" readonly style="width: 100%; padding: 10px; font-family: monospace; background: #fff; border: 2px solid #2c5aa0; border-radius: 5px;">
                    </div>
                    <div style="margin: 10px 0;">
                        <button onclick="copyURL()" style="margin-right: 10px;">ðŸ“‹ Copy URL</button>
                        <button onclick="openEntryForm()">ðŸ”— Test Entry Form</button>
                    </div>
                    <p style="font-size: 14px; color: #666;">Participants can use this link to register for your trial. You can also copy this link from your trial dashboard.</p>
                </div>
            </div>

            <!-- Entry Form Tab -->
            <div id="entry" class="tab-content">
                <div class="initial-question">
                    <h3>Dog Entry Form</h3>
                    <div id="entryFormContent">
                        <p style="color: #666; font-style: italic;">Please complete trial setup first or load an existing trial to access the entry form.</p>
                    </div>
                </div>
            </div>

            <!-- Results Tab -->
            <div id="results" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Trial Results</h3>
                    <button type="button" onclick="exportToCSV()">Export to CSV</button>
                </div>
                <div id="resultsContainer">
                    <p style="color: #666; font-style: italic;">No trial data available. Please complete trial setup first.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var currentUser = null;
        var currentTrialId = null;
        var dogData = [];
        var availableClasses = [];
        var availableJudges = [];
        var trialConfig = [];
        var entryResults = [];
        var runningOrders = {};
        var digitalScores = {};
        var totalDays = 0;
        var savedDays = 0;

        // Initialize application
        window.onload = function() {
            loadDogData();
            checkAutoLogin();
        };

        // Check for auto-login on page load
        function checkAutoLogin() {
            var rememberedUser = localStorage.getItem('currentUser');
            if (rememberedUser) {
                currentUser = JSON.parse(rememberedUser);
                showMainApp();
                loadUserTrials();
            }
        }

        // Load sample dog data
        function loadDogData() {
            dogData = [
                { regNumber: "DN12345", callName: "Buddy", ownerName: "John Smith" },
                { regNumber: "DN67890", callName: "Luna", ownerName: "Jane Doe" },
                { regNumber: "DN11111", callName: "Max", ownerName: "Bob Johnson" },
                { regNumber: "DN22222", callName: "Bella", ownerName: "Alice Brown" },
                { regNumber: "DN33333", callName: "Charlie", ownerName: "Mike Wilson" },
                { regNumber: "DN44444", callName: "Daisy", ownerName: "Sarah Davis" }
            ];
            availableClasses = ["Novice A", "Novice B", "Open A", "Open B", "Utility A", "Utility B", "Pre-Novice", "Graduate Novice"];
            availableJudges = ["Judge Smith", "Judge Johnson", "Judge Williams", "Judge Brown", "Judge Davis", "Judge Miller", "Judge Wilson"];
            console.log('Dog data loaded successfully:', dogData.length, 'records');
        }

        // Authentication functions
        function showAuthTab(tab, element) {
            var tabs = document.querySelectorAll('.auth-tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            element.classList.add('active');
            
            var forms = document.querySelectorAll('.auth-form');
            for (var i = 0; i < forms.length; i++) {
                forms[i].classList.remove('active');
            }
            document.getElementById(tab + 'Form').classList.add('active');
            
            // Clear messages
            document.getElementById('loginMessage').innerHTML = '';
            document.getElementById('registerMessage').innerHTML = '';
        }

        function handleLogin(event) {
            event.preventDefault();
            
            var username = document.getElementById('loginUsername').value.trim();
            var password = document.getElementById('loginPassword').value;
            var messageDiv = document.getElementById('loginMessage');
            
            if (!username || !password) {
                messageDiv.innerHTML = '<div class="alert alert-warning">Please enter both username and password.</div>';
                return;
            }
            
            var users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
            
            if (users[username] && users[username].password === password) {
                currentUser = users[username];
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
                loadUserTrials();
                messageDiv.innerHTML = '<div class="alert alert-success">Login successful!</div>';
            } else {
                messageDiv.innerHTML = '<div class="alert alert-warning">Invalid username or password. Please try again.</div>';
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            
            var username = document.getElementById('regUsername').value.trim();
            var password = document.getElementById('regPassword').value;
            var confirmPassword = document.getElementById('regConfirmPassword').value;
            var fullName = document.getElementById('regFullName').value.trim();
            var email = document.getElementById('regEmail').value.trim();
            var messageDiv = document.getElementById('registerMessage');
            
            // Validation
            if (!username || !password || !confirmPassword || !fullName || !email) {
                messageDiv.innerHTML = '<div class="alert alert-warning">Please fill in all fields.</div>';
                return;
            }
            
            if (username.length < 3) {
                messageDiv.innerHTML = '<div class="alert alert-warning">Username must be at least 3 characters long.</div>';
                return;
            }
            
            if (password.length < 6) {
                messageDiv.innerHTML = '<div class="alert alert-warning">Password must be at least 6 characters long.</div>';
                return;
            }
            
            if (password !== confirmPassword) {
                messageDiv.innerHTML = '<div class="alert alert-warning">Passwords do not match.</div>';
                return;
            }
            
            // Email validation
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                messageDiv.innerHTML = '<div class="alert alert-warning">Please enter a valid email address.</div>';
                return;
            }
            
            var users = JSON.parse(localStorage.getItem('trialUsers') || '{}');
            
            if (users[username]) {
                messageDiv.innerHTML = '<div class="alert alert-warning">Username already exists. Please choose a different username.</div>';
                return;
            }
            
            // Check if email already exists
            for (var user in users) {
                if (users[user].email === email) {
                    messageDiv.innerHTML = '<div class="alert alert-warning">Email address already registered. Please use a different email.</div>';
                    return;
                }
            }
            
            users[username] = {
                username: username,
                password: password,
                fullName: fullName,
                email: email,
                created: new Date().toISOString()
            };
            
            localStorage.setItem('trialUsers', JSON.stringify(users));
            messageDiv.innerHTML = '<div class="alert alert-success">Registration successful! You can now login with your credentials.</div>';
            
            // Clear form
            document.getElementById('registerForm').reset();
            
            // Auto-switch to login tab after 2 seconds
            setTimeout(function() {
                showAuthTab('login', document.querySelector('.auth-tab'));
            }, 2000);
        }

        function showMainApp() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = 'Welcome, ' + currentUser.fullName;
        }

        function logout() {
            currentUser = null;
            currentTrialId = null;
            trialConfig = [];
            entryResults = [];
            
            localStorage.removeItem('currentUser');
            
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            
            // Clear all form inputs
            var inputs = document.querySelectorAll('input');
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].type !== 'button' && inputs[i].type !== 'submit') {
                    inputs[i].value = '';
                }
            }
            
            // Reset displays
            document.getElementById('daysContainer').innerHTML = '';
            document.getElementById('myTrialsList').innerHTML = '';
            document.getElementById('entryFormContent').innerHTML = '<p style="color: #666; font-style: italic;">Please complete trial setup first or load an existing trial to access the entry form.</p>';
            document.getElementById('resultsContainer').innerHTML = '<p style="color: #666; font-style: italic;">No trial data available. Please complete trial setup first.</p>';
        }

        // Trial management functions
        function loadUserTrials() {
            var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
            var container = document.getElementById('myTrialsList');
            
            if (Object.keys(userTrials).length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No trials yet. Create your first trial!</p>';
                return;
            }
            
            var html = '';
            for (var trialId in userTrials) {
                if (userTrials.hasOwnProperty(trialId)) {
                    var trial = userTrials[trialId];
                    var created = new Date(trial.created).toLocaleDateString();
                    var days = trial.config ? getUniqueDays(trial.config).length : 0;
                    var totalEntries = trial.results ? trial.results.length : 0;
                    
                    var trialName = trial.name || 'Untitled Trial';
                    var trialStatus = (trial.config && trial.config.length > 0) ? 'Configured' : 'Setup Incomplete';
                    var statusColor = (trial.config && trial.config.length > 0) ? '#28a745' : '#ffc107';
                    
                    html += '<div class="trial-item">' +
                        '<div class="trial-info">' +
                        '<div class="trial-name">' + trialName + '</div>' +
                        '<div class="trial-meta">Created: ' + created + ' | Days: ' + days + ' | Entries: ' + totalEntries + '</div>' +
                        '<div class="trial-status" style="color: ' + statusColor + '; font-size: 12px; font-weight: bold;">' + trialStatus + '</div>' +
                        '</div>' +
                        '<div class="trial-actions">' +
                        '<button class="edit-btn" onclick="editTrial(\'' + trialId + '\')">Edit</button>';
                    
                    if (trial.config && trial.config.length > 0) {
                        html += '<button class="edit-btn" onclick="copyTrialLink(\'' + trialId + '\')" style="background: #17a2b8;">Copy Link</button>';
                    }
                    
                    html += '<button class="delete-btn" onclick="deleteTrial(\'' + trialId + '\')">Delete</button>' +
                        '</div>' +
                        '</div>';
                }
            }
            container.innerHTML = html;
        }

        function getUniqueDays(config) {
            var days = [];
            for (var i = 0; i < config.length; i++) {
                if (days.indexOf(config[i].day) === -1) {
                    days.push(config[i].day);
                }
            }
            return days;
        }

        function copyTrialLink(trialId) {
            var baseURL = window.location.origin + window.location.pathname;
            var shareableURL = baseURL + '?trial=' + trialId + '&mode=entry';
            
            navigator.clipboard.writeText(shareableURL).then(function() {
                showStatusMessage('Entry form link copied to clipboard!', 'success');
            }).catch(function() {
                // Fallback for browsers that don't support clipboard API
                var tempInput = document.createElement('input');
                tempInput.value = shareableURL;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showStatusMessage('Entry form link copied to clipboard!', 'success');
            });
        }

        function createNewTrial() {
            currentTrialId = 'trial_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('trialTitle').textContent = 'New Trial Setup';
            document.getElementById('trialName').value = '';
            document.getElementById('trialDays').value = '';
            document.getElementById('daysContainer').innerHTML = '';
            document.getElementById('saveTrialSection').style.display = 'none';
            document.getElementById('entryFormLink').style.display = 'none';
            
            trialConfig = [];
            entryResults = [];
            runningOrders = {};
            digitalScores = {};
            totalDays = 0;
            savedDays = 0;
            
            updateEntryForm();
            updateResultsDisplay();
            showTab('setup', document.querySelector('.nav-tab'));
        }

        function editTrial(trialId) {
            var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
            var trial = userTrials[trialId];
            
            if (!trial) {
                alert('Trial not found');
                return;
            }
            
            currentTrialId = trialId;
            document.getElementById('trialTitle').textContent = 'Editing: ' + (trial.name || 'Untitled Trial');
            document.getElementById('trialName').value = trial.name || '';
            
            trialConfig = trial.config || [];
            runningOrders = trial.runningOrders || {};
            digitalScores = trial.digitalScores || {};
            entryResults = trial.results || [];
            
            if (trialConfig.length > 0) {
                var maxDay = getMaxDay(trialConfig);
                document.getElementById('trialDays').value = maxDay;
                generateDays();
                
                setTimeout(function() {
                    populateExistingTrialData();
                }, 100);
                
                document.getElementById('saveTrialSection').style.display = 'block';
                generateShareableURL();
                document.getElementById('entryFormLink').style.display = 'block';
            } else {
                document.getElementById('saveTrialSection').style.display = 'none';
                document.getElementById('entryFormLink').style.display = 'none';
            }
            
            updateEntryForm();
            updateResultsDisplay();
            showTab('setup', document.querySelector('.nav-tab'));
        }

        function getMaxDay(config) {
            var max = 0;
            for (var i = 0; i < config.length; i++) {
                if (config[i].day > max) {
                    max = config[i].day;
                }
            }
            return max;
        }

        function populateExistingTrialData() {
            for (var i = 0; i < trialConfig.length; i++) {
                var config = trialConfig[i];
                var dayNum = config.day;
                var dateInput = document.getElementById('date_' + dayNum);
                if (dateInput) {
                    dateInput.value = config.date;
                }
                
                var classInput = document.getElementById('class_' + dayNum + '_' + config.classNum);
                if (classInput) {
                    classInput.value = config.className;
                }
                
                var judgeInput = document.getElementById('judge_' + dayNum + '_' + config.classNum + '_' + config.roundNum);
                if (judgeInput) {
                    judgeInput.value = config.judge;
                }
                
                var feoInput = document.getElementById('feo_' + dayNum + '_' + config.classNum + '_' + config.roundNum);
                if (feoInput) {
                    feoInput.checked = config.feoOffered || false;
                }
            }
        }

        function deleteTrial(trialId) {
            if (confirm('Are you sure you want to delete this trial? This action cannot be undone.')) {
                var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
                delete userTrials[trialId];
                localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
                
                // Also remove from public trials
                var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
                delete publicTrials[trialId];
                localStorage.setItem('publicTrials', JSON.stringify(publicTrials));
                
                loadUserTrials();
                showStatusMessage('Trial deleted successfully.', 'success');
            }
        }

        // Trial setup functions
        function generateDays() {
            var numDays = parseInt(document.getElementById('trialDays').value);
            if (!numDays || numDays < 1) {
                alert('Please enter a valid number of days');
                return;
            }

            totalDays = numDays;
            savedDays = 0;
            var container = document.getElementById('daysContainer');
            container.innerHTML = '';

            for (var i = 1; i <= numDays; i++) {
                createDaySection(i, container);
            }
        }

        function createDaySection(dayNum, container) {
            var dayDiv = document.createElement('div');
            dayDiv.className = 'day-container';
            dayDiv.innerHTML = 
                '<div class="day-header">Day ' + dayNum + '</div>' +
                '<div class="form-group">' +
                '<span class="label">Date for Day ' + dayNum + ':</span>' +
                '<input type="date" id="date_' + dayNum + '" onchange="updateDayData(' + dayNum + ')">' +
                '</div>' +
                '<div class="classes-section">' +
                '<h4>Classes for Day ' + dayNum + '</h4>' +
                '<div class="form-group">' +
                '<span class="label">Number of classes:</span>' +
                '<input type="number" id="numClasses_' + dayNum + '" min="1" max="10" placeholder="Enter number" onchange="generateClasses(' + dayNum + ')">' +
                '</div>' +
                '<div id="classesContainer_' + dayNum + '"></div>' +
                '</div>';
            
            container.appendChild(dayDiv);
        }

        function generateClasses(dayNum) {
            var numClasses = parseInt(document.getElementById('numClasses_' + dayNum).value);
            if (!numClasses || numClasses < 1) {
                return;
            }

            var container = document.getElementById('classesContainer_' + dayNum);
            container.innerHTML = '';

            for (var i = 1; i <= numClasses; i++) {
                createClassSection(dayNum, i, container);
            }
        }

        function createClassSection(dayNum, classNum, container) {
            var classDiv = document.createElement('div');
            classDiv.className = 'class-container';
            classDiv.innerHTML = 
                '<div class="class-header">Class ' + classNum + '</div>' +
                '<div class="form-group">' +
                '<span class="label">Class Name:</span>' +
                '<select id="class_' + dayNum + '_' + classNum + '" onchange="updateClassData(' + dayNum + ', ' + classNum + ')">' +
                '<option value="">Select Class</option>' +
                generateClassOptions() +
                '</select>' +
                '</div>' +
                '<div class="form-group">' +
                '<span class="label">Number of rounds:</span>' +
                '<input type="number" id="numRounds_' + dayNum + '_' + classNum + '" min="1" max="5" placeholder="Enter number" onchange="generateRounds(' + dayNum + ', ' + classNum + ')">' +
                '</div>' +
                '<div id="roundsContainer_' + dayNum + '_' + classNum + '"></div>';
            
            container.appendChild(classDiv);
        }

        function generateClassOptions() {
            var options = '';
            for (var i = 0; i < availableClasses.length; i++) {
                options += '<option value="' + availableClasses[i] + '">' + availableClasses[i] + '</option>';
            }
            return options;
        }

        function generateRounds(dayNum, classNum) {
            var numRounds = parseInt(document.getElementById('numRounds_' + dayNum + '_' + classNum).value);
            if (!numRounds || numRounds < 1) {
                return;
            }

            var container = document.getElementById('roundsContainer_' + dayNum + '_' + classNum);
            container.innerHTML = '';

            for (var i = 1; i <= numRounds; i++) {
                createRoundSection(dayNum, classNum, i, container);
            }
        }

        function createRoundSection(dayNum, classNum, roundNum, container) {
            var roundDiv = document.createElement('div');
            roundDiv.className = 'rounds-section';
            roundDiv.innerHTML = 
                '<h5>Round ' + roundNum + '</h5>' +
                '<div class="form-group">' +
                '<span class="label">Judge:</span>' +
                '<select id="judge_' + dayNum + '_' + classNum + '_' + roundNum + '" onchange="updateRoundData(' + dayNum + ', ' + classNum + ', ' + roundNum + ')">' +
                '<option value="">Select Judge</option>' +
                generateJudgeOptions() +
                '</select>' +
                '<label style="margin-left: 20px;">' +
                '<input type="checkbox" id="feo_' + dayNum + '_' + classNum + '_' + roundNum + '" onchange="updateRoundData(' + dayNum + ', ' + classNum + ', ' + roundNum + ')"> FEO Offered' +
                '</label>' +
                '</div>';
            
            container.appendChild(roundDiv);
        }

        function generateJudgeOptions() {
            var options = '';
            for (var i = 0; i < availableJudges.length; i++) {
                options += '<option value="' + availableJudges[i] + '">' + availableJudges[i] + '</option>';
            }
            return options;
        }

        function updateDayData(dayNum) {
            checkIfAllDaysConfigured();
        }

        function updateClassData(dayNum, classNum) {
            checkIfAllDaysConfigured();
        }

        function updateRoundData(dayNum, classNum, roundNum) {
            var dateInput = document.getElementById('date_' + dayNum);
            var classInput = document.getElementById('class_' + dayNum + '_' + classNum);
            var judgeInput = document.getElementById('judge_' + dayNum + '_' + classNum + '_' + roundNum);
            var feoInput = document.getElementById('feo_' + dayNum + '_' + classNum + '_' + roundNum);
            
            if (dateInput.value && classInput.value && judgeInput.value) {
                // Update or add to trialConfig
                var configIndex = -1;
                for (var i = 0; i < trialConfig.length; i++) {
                    if (trialConfig[i].day === dayNum && 
                        trialConfig[i].classNum === classNum && 
                        trialConfig[i].roundNum === roundNum) {
                        configIndex = i;
                        break;
                    }
                }
                
                var configItem = {
                    day: dayNum,
                    date: dateInput.value,
                    classNum: classNum,
                    className: classInput.value,
                    roundNum: roundNum,
                    judge: judgeInput.value,
                    feoOffered: feoInput.checked
                };
                
                if (configIndex >= 0) {
                    trialConfig[configIndex] = configItem;
                } else {
                    trialConfig.push(configItem);
                }
            }
            
            checkIfAllDaysConfigured();
        }

        function checkIfAllDaysConfigured() {
            // Check if we have a reasonable amount of configuration
            var hasValidConfig = trialConfig.length > 0;
            
            if (hasValidConfig) {
                document.getElementById('saveTrialSection').style.display = 'block';
            } else {
                document.getElementById('saveTrialSection').style.display = 'none';
            }
        }

        function saveTrialData() {
            if (!currentUser) {
                alert("Please log in first.");
                return;
            }
            
            if (!currentTrialId) {
                alert("Please create a new trial first.");
                return;
            }
            
            var trialName = document.getElementById('trialName').value.trim();
            if (!trialName) {
                alert("Please enter a trial name.");
                return;
            }

            if (trialConfig.length === 0) {
                alert("Please configure at least one round before saving the trial.");
                return;
            }
            
            var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
            
            var trialData = {
                name: trialName,
                config: trialConfig,
                results: entryResults,
                runningOrders: runningOrders,
                digitalScores: digitalScores,
                owner: currentUser.username,
                created: userTrials[currentTrialId] && userTrials[currentTrialId].created ? userTrials[currentTrialId].created : new Date().toISOString(),
                updated: new Date().toISOString()
            };
            
            userTrials[currentTrialId] = trialData;
            localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
            
            // Also save to public trials for sharing
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            publicTrials[currentTrialId] = trialData;
            localStorage.setItem('publicTrials', JSON.stringify(publicTrials));
            
            generateShareableURL();
            document.getElementById('entryFormLink').style.display = 'block';
            showStatusMessage("Trial saved successfully!", "success");
            loadUserTrials();
            updateEntryForm();
        }

        function generateShareableURL() {
            var baseURL = window.location.origin + window.location.pathname;
            var shareableURL = baseURL + '?trial=' + currentTrialId + '&mode=entry';
            document.getElementById('shareableURL').value = shareableURL;
        }

        function copyURL() {
            var urlInput = document.getElementById('shareableURL');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(urlInput.value).then(function() {
                showStatusMessage('URL copied to clipboard!', 'success');
            }).catch(function() {
                document.execCommand('copy');
                showStatusMessage('URL copied to clipboard!', 'success');
            });
        }

        function openEntryForm() {
            var url = document.getElementById('shareableURL').value;
            window.open(url, '_blank');
        }

        // Tab functions
        function showTab(tabName, element) {
            var tabs = document.querySelectorAll('.nav-tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            if (element) {
                element.classList.add('active');
            }
            
            var contents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'entry') {
                updateEntryForm();
            } else if (tabName === 'results') {
                updateResultsDisplay();
            }
        }

        // Entry Form functions
        function updateEntryForm() {
            var container = document.getElementById('entryFormContent');
            
            if (!currentTrialId || trialConfig.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">Please complete trial setup first or load an existing trial to access the entry form.</p>';
                return;
            }
            
            var html = 
                '<form id="entryForm">' +
                '<div class="form-group">' +
                '<span class="label">Registration Number:</span>' +
                '<input type="text" id="regNumber" placeholder="Enter registration number" onchange="updateCallName()">' +
                '<span id="callName" style="margin-left: 15px; font-weight: bold; color: #666;">Call Name will appear here</span>' +
                '</div>' +
                '<div class="form-group">' +
                '<span class="label">Handler Name:</span>' +
                '<input type="text" id="handlerName" placeholder="Enter handler name">' +
                '</div>' +
                '<div class="form-group">' +
                '<span class="label">Select Trial(s):</span>' +
                '<div style="font-size: 12px; color: #666; margin-bottom: 10px;">You can select multiple trials for the same dog</div>' +
                '</div>' +
                '<div id="trialOptions">' + generateTrialOptions() + '</div>' +
                '<div class="form-group">' +
                '<button type="button" onclick="submitEntry()">Submit Entry</button>' +
                '<button type="button" onclick="clearEntryForm()" style="background: #6c757d; margin-left: 10px;">Clear Form</button>' +
                '</div>' +
                '</form>';
            
            container.innerHTML = html;
        }

        function updateCallName() {
            var regNumber = document.getElementById('regNumber').value.trim();
            var callNameSpan = document.getElementById('callName');
            
            if (regNumber) {
                for (var i = 0; i < dogData.length; i++) {
                    if (dogData[i].regNumber.toLowerCase() === regNumber.toLowerCase()) {
                        callNameSpan.textContent = dogData[i].callName;
                        callNameSpan.style.color = '#28a745';
                        return;
                    }
                }
                callNameSpan.textContent = 'Registration not found - will use "Unknown"';
                callNameSpan.style.color = '#ffc107';
            } else {
                callNameSpan.textContent = 'Call Name will appear here';
                callNameSpan.style.color = '#666';
            }
        }

        function generateTrialOptions() {
            if (trialConfig.length === 0) return '';
            
            // Group by day and class
            var grouped = {};
            for (var i = 0; i < trialConfig.length; i++) {
                var config = trialConfig[i];
                var dayKey = config.date;
                var classKey = config.className;
                
                if (!grouped[dayKey]) grouped[dayKey] = {};
                if (!grouped[dayKey][classKey]) grouped[dayKey][classKey] = [];
                
                grouped[dayKey][classKey].push(config);
            }
            
            var html = '';
            for (var date in grouped) {
                html += '<div class="day-group">' +
                        '<div class="day-group-header">' + date + '</div>';
                
                for (var className in grouped[date]) {
                    html += '<div class="class-group">' +
                            '<div class="class-group-header">' + className + '</div>';
                    
                    var rounds = grouped[date][className];
                    for (var j = 0; j < rounds.length; j++) {
                        var round = rounds[j];
                        var optionId = 'option_' + round.day + '_' + round.classNum + '_' + round.roundNum;
                        
                        html += '<div class="trial-option">' +
                                '<label>' +
                                '<input type="checkbox" id="' + optionId + '" value="' + 
                                round.date + '|' + round.className + '|' + round.roundNum + '|' + round.judge + '">' +
                                'Round ' + round.roundNum + ' - Judge: ' + round.judge +
                                '</label>';
                        
                        if (round.feoOffered) {
                            html += '<div class="entry-type-options">' +
                                    '<label><input type="radio" name="type_' + optionId + '" value="regular" checked> Regular</label>' +
                                    '<label><input type="radio" name="type_' + optionId + '" value="feo"> FEO (For Exhibition Only)</label>' +
                                    '</div>';
                        }
                        
                        html += '</div>';
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            return html;
        }

        function submitEntry() {
            var regNumber = document.getElementById('regNumber').value.trim();
            var handlerName = document.getElementById('handlerName').value.trim();
            
            if (!regNumber || !handlerName) {
                alert('Please enter both registration number and handler name.');
                return;
            }
            
            // Find call name
            var callName = 'Unknown';
            for (var i = 0; i < dogData.length; i++) {
                if (dogData[i].regNumber.toLowerCase() === regNumber.toLowerCase()) {
                    callName = dogData[i].callName;
                    break;
                }
            }
            
            // Collect selected trials
            var selectedTrials = [];
            var checkboxes = document.querySelectorAll('#trialOptions input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one trial.');
                return;
            }
            
            for (var i = 0; i < checkboxes.length; i++) {
                var checkbox = checkboxes[i];
                var parts = checkbox.value.split('|');
                var entryType = 'regular';
                
                // Check for FEO option
                var radioName = 'type_' + checkbox.id;
                var radioButtons = document.querySelectorAll('input[name="' + radioName + '"]');
                for (var j = 0; j < radioButtons.length; j++) {
                    if (radioButtons[j].checked) {
                        entryType = radioButtons[j].value;
                        break;
                    }
                }
                
                selectedTrials.push({
                    date: parts[0],
                    className: parts[1],
                    round: parseInt(parts[2]),
                    judge: parts[3],
                    entryType: entryType
                });
            }
            
            // Add entries to results
            for (var i = 0; i < selectedTrials.length; i++) {
                var trial = selectedTrials[i];
                entryResults.push({
                    regNumber: regNumber,
                    callName: callName,
                    handler: handlerName,
                    date: trial.date,
                    className: trial.className,
                    round: trial.round,
                    judge: trial.judge,
                    entryType: trial.entryType,
                    timestamp: new Date().toISOString()
                });
            }
            
            // Save to storage
            if (currentUser && currentTrialId) {
                var userTrials = JSON.parse(localStorage.getItem('trials_' + currentUser.username) || '{}');
                if (userTrials[currentTrialId]) {
                    userTrials[currentTrialId].results = entryResults;
                    userTrials[currentTrialId].updated = new Date().toISOString();
                    localStorage.setItem('trials_' + currentUser.username, JSON.stringify(userTrials));
                }
                
                var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
                if (publicTrials[currentTrialId]) {
                    publicTrials[currentTrialId].results = entryResults;
                    publicTrials[currentTrialId].updated = new Date().toISOString();
                    localStorage.setItem('publicTrials', JSON.stringify(publicTrials));
                }
            }
            
            showStatusMessage('Entry submitted successfully!', 'success');
            clearEntryForm();
            updateResultsDisplay();
            loadUserTrials();
        }

        function clearEntryForm() {
            document.getElementById('regNumber').value = '';
            document.getElementById('handlerName').value = '';
            document.getElementById('callName').textContent = 'Call Name will appear here';
            document.getElementById('callName').style.color = '#666';
            
            var checkboxes = document.querySelectorAll('#trialOptions input[type="checkbox"]');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            
            var radios = document.querySelectorAll('#trialOptions input[type="radio"]');
            for (var i = 0; i < radios.length; i++) {
                if (radios[i].value === 'regular') {
                    radios[i].checked = true;
                } else {
                    radios[i].checked = false;
                }
            }
        }

        // Results functions
        function updateResultsDisplay() {
            var container = document.getElementById('resultsContainer');
            
            if (entryResults.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No entries yet. Use the Entry Form to add participants.</p>';
                return;
            }
            
            // Group results by date and class
            var grouped = {};
            for (var i = 0; i < entryResults.length; i++) {
                var entry = entryResults[i];
                var key = entry.date + '|' + entry.className + '|' + entry.round;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        date: entry.date,
                        className: entry.className,
                        round: entry.round,
                        judge: entry.judge,
                        entries: []
                    };
                }
                
                grouped[key].entries.push(entry);
            }
            
            var html = '<div class="results-grid">';
            
            for (var key in grouped) {
                var group = grouped[key];
                html += '<div class="result-column">' +
                        '<div class="column-header">' +
                        '<div class="column-date">' + group.date + '</div>' +
                        '<div class="column-judge">Judge: ' + group.judge + '</div>' +
                        '<div class="column-class-round">' + group.className + ' - Round ' + group.round + '</div>' +
                        '</div>' +
                        '<div class="column-entries">';
                
                // Sort entries by registration number
                group.entries.sort(function(a, b) {
                    return a.regNumber.localeCompare(b.regNumber);
                });
                
                for (var j = 0; j < group.entries.length; j++) {
                    var entry = group.entries[j];
                    var badgeClass = entry.entryType === 'feo' ? 'badge-feo' : 'badge-regular';
                    var badgeText = entry.entryType === 'feo' ? 'FEO' : 'REG';
                    
                    html += '<div class="entry-item">' +
                            entry.regNumber + ' - ' + entry.callName + ' (' + entry.handler + ')' +
                            '<span class="entry-type-badge ' + badgeClass + '">' + badgeText + '</span>' +
                            '</div>';
                }
                
                html += '</div></div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function exportToCSV() {
            if (entryResults.length === 0) {
                alert('No entries to export');
                return;
            }
            
            var csv = 'Registration,Call Name,Handler,Date,Class,Round,Judge,Entry Type,Timestamp\n';
            
            for (var i = 0; i < entryResults.length; i++) {
                var entry = entryResults[i];
                csv += entry.regNumber + ',' + entry.callName + ',' + entry.handler + ',' + 
                       entry.date + ',' + entry.className + ',' + entry.round + ',' + 
                       entry.judge + ',' + entry.entryType + ',' + entry.timestamp + '\n';
            }
            
            downloadFile(csv, 'trial_entries.csv', 'text/csv');
            showStatusMessage('Entries exported successfully!', 'success');
        }

        // Utility functions
        function showStatusMessage(message, type) {
            var alertClass = 'alert-info';
            if (type === 'success') alertClass = 'alert-success';
            if (type === 'warning') alertClass = 'alert-warning';
            
            var messageDiv = document.createElement('div');
            messageDiv.className = 'alert ' + alertClass;
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '10000';
            messageDiv.style.maxWidth = '300px';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(function() {
                document.body.removeChild(messageDiv);
            }, 3000);
        }

        function downloadFile(content, filename, contentType) {
            var blob = new Blob([content], { type: contentType });
            var url = window.URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        // Check for URL parameters on load
        window.addEventListener('load', function() {
            var urlParams = new URLSearchParams(window.location.search);
            var trialId = urlParams.get('trial');
            var mode = urlParams.get('mode');
            
            if (trialId && mode === 'entry') {
                // Load public trial for entry
                loadPublicTrialForEntry(trialId);
            }
        });

        function loadPublicTrialForEntry(trialId) {
            var publicTrials = JSON.parse(localStorage.getItem('publicTrials') || '{}');
            var trial = publicTrials[trialId];
            
            if (!trial) {
                alert('Trial not found or no longer available.');
                return;
            }
            
            // Load trial data for entry form
            currentTrialId = trialId;
            trialConfig = trial.config || [];
            entryResults = trial.results || [];
            
            // Show a simplified interface for entry only
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = 'Entering: ' + (trial.name || 'Trial');
            
            // Hide user trials section and limit to entry tab only
            document.querySelector('.my-trials').style.display = 'none';
            document.querySelector('.logout-btn').style.display = 'none';
            
            // Show only entry tab
            var tabs = document.querySelectorAll('.nav-tab');
            for (var i = 0; i < tabs.length; i++) {
                if (tabs[i].textContent !== 'Entry Form') {
                    tabs[i].style.display = 'none';
                }
            }
            
            updateEntryForm();
            showTab('entry', document.querySelector('.nav-tab'));
        }
    </script>
</body>
</html>
